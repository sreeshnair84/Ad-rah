# Azure Deployment Guide - Adara Screen Digital Signage Platform

## üìã **Prerequisites**

1. **Azure Subscription** with appropriate permissions
2. **Azure CLI** installed and configured
3. **Terraform** installed (v1.5+)
4. **GitHub** repository with secrets configured
5. **Docker** for local testing (optional)

## üöÄ **Step-by-Step Deployment**

### **Step 1: Azure Setup**

1. **Login to Azure CLI:**
```bash
az login
az account set --subscription "your-subscription-id"
```

2. **Create Service Principal for GitHub Actions:**
```bash
az ad sp create-for-rbac --name "adara-signage-github-actions" \
  --role contributor \
  --scopes /subscriptions/your-subscription-id \
  --sdk-auth
```

3. **Create Terraform Backend Storage:**
```bash
# Create resource group for Terraform state
az group create --name rg-terraform-state --location "UAE Central"

# Create storage account
az storage account create \
  --name terraformstateXXXXX \  # Replace XXXXX with random characters
  --resource-group rg-terraform-state \
  --location "UAE Central" \
  --sku Standard_LRS

# Create container
az storage container create \
  --name tfstate \
  --account-name terraformstateXXXXX
```

### **Step 2: GitHub Repository Setup**

Add the following secrets to your GitHub repository (`Settings > Secrets and variables > Actions`):

#### **Azure Authentication:**
- `AZURE_CREDENTIALS`: JSON output from service principal creation
- `AZURE_SUBSCRIPTION_ID`: Your Azure subscription ID
- `AZURE_TENANT_ID`: Your Azure tenant ID
- `AZURE_CLIENT_ID`: Service principal client ID
- `AZURE_CLIENT_SECRET`: Service principal client secret

#### **Terraform Backend:**
- `TERRAFORM_STORAGE_ACCOUNT`: Storage account name for Terraform state
- `TERRAFORM_CONTAINER_NAME`: `tfstate`
- `TERRAFORM_STATE_KEY`: `adara-signage.tfstate`
- `TERRAFORM_RESOURCE_GROUP`: `rg-terraform-state`

#### **Application Configuration:**
- `RESOURCE_GROUP_NAME`: `rg-adara-signage-prod`
- `AZURE_LOCATION`: `UAE Central`
- `PROJECT_NAME`: `adara-signage`
- `CONTAINER_REGISTRY_NAME`: Will be generated by Terraform
- `BACKEND_CONTAINER_APP_NAME`: Will be generated by Terraform
- `NEXT_PUBLIC_API_URL`: Backend URL (set after first deployment)
- `AZURE_STATIC_WEB_APPS_API_TOKEN`: Generated by Azure Static Web Apps

### **Step 3: Infrastructure Deployment**

1. **Clone the repository:**
```bash
git clone https://github.com/your-username/adara-signage.git
cd adara-signage
```

2. **Configure Terraform variables:**
```bash
cd terraform
cp terraform.tfvars.example terraform.tfvars
# Edit terraform.tfvars with your specific values
```

3. **Initialize and deploy infrastructure:**
```bash
# Initialize Terraform
terraform init \
  -backend-config="storage_account_name=terraformstateXXXXX" \
  -backend-config="container_name=tfstate" \
  -backend-config="key=adara-signage.tfstate" \
  -backend-config="resource_group_name=rg-terraform-state"

# Plan deployment
terraform plan

# Deploy infrastructure
terraform apply
```

4. **Note the output values:**
```bash
terraform output
```

### **Step 4: Application Deployment**

1. **Update GitHub Secrets** with Terraform outputs:
   - Update `CONTAINER_REGISTRY_NAME`
   - Update `BACKEND_CONTAINER_APP_NAME`
   - Update `NEXT_PUBLIC_API_URL`
   - Update `AZURE_STATIC_WEB_APPS_API_TOKEN`

2. **Trigger deployments:**
   - Push changes to `main` branch to trigger infrastructure updates
   - Push changes to `backend/` to trigger backend deployment
   - Push changes to `frontend/` to trigger frontend deployment

## üîß **Post-Deployment Configuration**

### **Step 1: Configure Custom Domain (Optional)**

1. **For Static Web App:**
```bash
az staticwebapp hostname set \
  --name your-static-web-app-name \
  --resource-group rg-adara-signage-prod \
  --hostname yourdomain.com
```

2. **For Container App:**
```bash
az containerapp hostname add \
  --name your-backend-app-name \
  --resource-group rg-adara-signage-prod \
  --hostname api.yourdomain.com
```

### **Step 2: Configure SSL Certificates**

SSL certificates are automatically managed by Azure for both Static Web Apps and Container Apps.

### **Step 3: Set up Monitoring**

1. **Application Insights** is automatically configured
2. **Log Analytics** workspace is created for centralized logging
3. **Alerts can be configured** through Azure Monitor

### **Step 4: Database Initialization**

Run the database initialization scripts if needed:

```bash
# Connect to your backend API and run initialization
curl -X POST "https://your-backend-url/api/admin/initialize" \
  -H "Authorization: Bearer admin-token"
```

## üí∞ **Cost Optimization**

### **Estimated Monthly Costs (UAE Central):**

| Service | Configuration | Est. Monthly Cost (USD) |
|---------|---------------|-------------------------|
| Azure Container Apps | 0.5 CPU, 1GB RAM | $15-30 |
| Azure Static Web Apps | Free tier | $0 |
| Azure Cosmos DB | 400 RU/s | $25-40 |
| Azure Blob Storage | 10GB + operations | $2-5 |
| Azure CDN | Standard tier | $5-10 |
| Azure Key Vault | Standard tier | $1-3 |
| Log Analytics | 5GB/month | $10-15 |
| **Total Estimated** | | **$58-103/month** |

### **Cost Optimization Tips:**

1. **Auto-scaling**: Container Apps scale to zero when not in use
2. **Cosmos DB**: Use serverless for development environments
3. **Storage**: Use Cool tier for infrequently accessed content
4. **Monitoring**: Set up budget alerts in Azure Cost Management

## üîç **Monitoring and Troubleshooting**

### **Health Checks:**

- **Backend**: `https://your-backend-url/health`
- **Frontend**: Automatic health checks via Static Web Apps
- **Database**: Monitor through Azure Cosmos DB metrics

### **Logs:**

- **Container Apps**: View through Log Analytics workspace
- **Static Web Apps**: View through Azure portal
- **Application Insights**: Detailed application telemetry

### **Common Issues:**

1. **Container App not starting**: Check secrets and environment variables
2. **Static Web App deployment failed**: Verify build configuration
3. **Database connection issues**: Check connection string and firewall rules
4. **CORS errors**: Verify API URL configuration in frontend

## üîí **Security Considerations**

1. **Key Vault**: All secrets stored securely in Azure Key Vault
2. **Managed Identity**: Container Apps use managed identity for Azure services
3. **Network Security**: Consider implementing VNet integration for production
4. **HTTPS**: All traffic encrypted using SSL/TLS
5. **RBAC**: Implement proper role-based access control

## üìà **Scaling Considerations**

1. **Horizontal Scaling**: Container Apps can scale up to 10 instances
2. **Database Scaling**: Cosmos DB can scale RU/s based on demand
3. **Storage Scaling**: Blob storage scales automatically
4. **CDN**: Global distribution for media content

## üîÑ **Backup and Disaster Recovery**

1. **Database**: Automatic backups with point-in-time restore
2. **Storage**: Versioning and soft delete enabled
3. **Infrastructure**: Terraform state stored in Azure Storage
4. **Application Code**: Version controlled in Git

## üìû **Support and Maintenance**

1. **Automated Updates**: GitHub Actions handle deployments
2. **Monitoring**: Application Insights provides detailed metrics
3. **Alerting**: Configure alerts for critical issues
4. **Documentation**: Keep deployment docs updated

For additional support or questions, refer to the project's GitHub repository or contact the development team.